{"version":3,"sources":["src/pages/Auth/Login/auth.tsx"],"sourcesContent":["import React, { useEffect, useState } from \"react\";\r\nimport { history, useModel } from \"@umijs/max\";\r\nimport {\r\n  authingClient,\r\n  checkTokenValid,\r\n  getCurrentUser,\r\n  handleLogout,\r\n  isWithWhiteList,\r\n} from \"@/utils/auth\";\r\n\r\nexport default function Login() {\r\n  const { initialState, setInitialState } = useModel(\"@@initialState\");\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n\r\n  const handleLogin = async () => {\r\n    setLoading(true);\r\n    setError(\"\");\r\n\r\n    try {\r\n      // 跳转到Authing登录页\r\n      await authingClient.loginWithRedirect();\r\n    } catch (error: any) {\r\n      setError(error.message || \"登录失败，请重试\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const reLogin = async () => {\r\n    const loggedIn = await checkTokenValid();\r\n    const pathname = window.location.pathname;\r\n\r\n    if (!loggedIn) {\r\n      // ⚠️ 如果当前就是回调页，不要再跳\r\n      setTimeout(() => authingClient.loginWithRedirect(), 1000);\r\n    } else {\r\n\r\n      // 如果登录成功，跳转到之前访问的页面\r\n      if (!initialState?.currentUser || Object.keys(initialState?.currentUser).length === 0) {\r\n        const currentUser = await getCurrentUser()\r\n        setInitialState( state => ({\r\n          ...state,\r\n          currentUser,\r\n        }));\r\n      }\r\n\r\n      if (isWithWhiteList(pathname)) {\r\n        history.push(\"/\");\r\n      }\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    reLogin();\r\n  }, []);\r\n\r\n  return (\r\n    <div className=\"cs-p-8 cs-max-w-md cs-mx-auto\">\r\n      <h1 className=\"cs-text-2xl cs-font-bold cs-mb-6 cs-text-center\">\r\n        用户登录\r\n      </h1>\r\n\r\n      {error && (\r\n        <div className=\"cs-bg-red-100 cs-text-red-700 cs-p-4 cs-rounded cs-mb-4\">\r\n          {error}\r\n        </div>\r\n      )}\r\n\r\n      <button\r\n        onClick={handleLogin}\r\n        disabled={loading}\r\n        className=\"cs-w-full cs-bg-blue-600 cs-text-white cs-py-3 cs-px-4 cs-rounded-lg hover:cs-bg-blue-700 cs-transition-colors disabled:cs-bg-gray-400\"\r\n      >\r\n        {loading ? \"登录中...\" : \"使用Authing登录\"}\r\n      </button>\r\n\r\n      <button\r\n        onClick={handleLogout}\r\n        className=\"cs-w-full cs-mt-4 cs-bg-gray-600 cs-text-white cs-py-3 cs-px-4 cs-rounded-lg hover:cs-bg-gray-700 cs-transition-colors\"\r\n      >\r\n        退出登录\r\n      </button>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"+PAUA,+CAAwB,8BAVmB,gBACT,gBAO3B,YAEQ,SAAS,IACtB,GAAM,CAAE,aAAA,CAAY,CAAE,gBAAA,CAAe,CAAE,CAAG,GAAA,UAAQ,EAAC,kBAC7C,CAAC,EAAS,EAAW,CAAG,GAAA,UAAQ,EAAC,CAAA,GACjC,CAAC,EAAO,EAAS,CAAG,GAAA,UAAQ,EAAC,IAE7B,EAAc,UAClB,EAAW,CAAA,GACX,EAAS,IAET,GAAI,CAEF,MAAM,eAAa,CAAC,iBAAiB,GACvC,CAAE,MAAO,EAAY,CACnB,EAAS,EAAM,OAAO,EAAI,oDAC5B,QAAU,CACR,EAAW,CAAA,GACb,CACF,EAEM,EAAU,UACd,IAAM,EAAW,MAAM,GAAA,iBAAe,IAChC,EAAW,OAAO,QAAQ,CAAC,QAAQ,CAEzC,GAAK,EAGE,CAGL,GAAI,QAAC,SAAA,EAAc,WAAW,GAAI,AAAkD,IAAlD,OAAO,IAAI,OAAC,SAAA,EAAc,WAAW,EAAE,MAAM,CAAQ,CACrF,IAAM,EAAc,MAAM,GAAA,gBAAc,IACxC,EAAiB,GAAU,CAAA,CACzB,GAAG,CAAK,CACR,YAAA,CACF,CAAA,GACF,CAEI,GAAA,iBAAe,EAAC,IAClB,SAAO,CAAC,IAAI,CAAC,KAEjB,MAfE,WAAW,IAAM,eAAa,CAAC,iBAAiB,GAAI,KAgBxD,EAMA,MAJA,GAAA,WAAS,EAAC,KACR,IACF,EAAG,EAAE,EAGH,WAAC,OAAI,UAAU,0CACb,UAAC,MAAG,UAAU,2DAAkD,6BAI/D,GACC,UAAC,OAAI,UAAU,mEACZ,IAIL,UAAC,UACC,QAAS,EACT,SAAU,EACV,UAAU,kJAET,EAAU,wBAAW,oCAGxB,UAAC,UACC,QAAS,cAAY,CACrB,UAAU,kIACX,gCAKP"}